# 飞书 AI 机器人接入指南

本文档指导运营者为新客户开通飞书 AI 机器人服务的完整流程。

---

## 前置准备

- 已部署 OpenClaw 管理面板（`docker compose up -d`）
- 客户提供的飞书企业管理员身份或授权
- 智谱 API Key（[open.bigmodel.cn](https://open.bigmodel.cn) 申请）

---

## 第一步：创建飞书应用

1. 登录 [飞书开放平台](https://open.feishu.cn)
2. 点击 **创建企业自建应用**
3. 填写应用信息：
   - 应用名称：建议用客户品牌名 + "AI 助手"（如 "XX公司 AI 助手"）
   - 应用描述：简要说明功能
   - 应用图标：上传客户 logo

## 第二步：配置机器人能力

1. 进入应用设置页 → **添加应用能力** → 选择 **机器人**
2. 设置机器人信息：
   - 机器人名称：与应用名一致
   - 机器人描述：如 "基于 AI 的智能助手"

## 第三步：配置事件订阅（WebSocket 长连接）

> 这是关键步骤，OpenClaw 使用 WebSocket 长连接模式，不需要配置回调 URL。

1. 进入 **事件与回调** → **订阅方式**
2. 选择 **使用长连接接收事件/回调**（WebSocket）
3. 添加以下事件订阅：
   - `im.message.receive_v1` — 接收消息
   - `im.message.reaction.created_v1` — 消息表情回复（可选）

## 第四步：配置权限

进入 **权限管理**，开通以下权限：

| 权限 | 权限名称 | 说明 |
|------|---------|------|
| `im:message` | 获取与发送单聊、群组消息 | **必须** |
| `im:message:send_as_bot` | 以应用的身份发消息 | **必须** |
| `im:resource` | 获取与上传图片或文件资源 | 推荐 |
| `im:chat` | 获取群组信息 | 推荐 |
| `contact:contact.base:readonly` | 获取通讯录基本信息 | 推荐 |

## 第五步：获取凭据

在应用的 **凭证与基础信息** 页面获取：
- **App ID**：`cli_xxxxxxxxxxxxxxx`
- **App Secret**：点击查看并复制

## 第六步：在管理面板创建客户

1. 访问管理面板：`http://your-server:3001`
2. 输入管理面板用户名/密码
3. 点击 **+ 创建客户**
4. 填写信息：
   - **场景模板**：根据客户需求选择
   - **客户名称**：小写字母+数字（如 `acme-corp`）
   - **端口号**：分配一个未使用的端口（如 `18790`）
   - **App ID / Secret**：填入第五步获取的凭据
   - **域名**：国内选 `feishu`，国际版选 `lark`
   - **智谱 API Key**：填入 API Key
5. 点击 **创建并启动**

## 第七步：发布应用

1. 回到飞书开放平台
2. 点击 **版本管理与发布** → **创建版本**
3. 提交审核（企业内部应用通常免审核，直接发布）
4. 在 **可用范围** 中设置哪些员工可以使用

## 第八步：验证

1. 在管理面板检查客户状态是否显示「运行中」
2. 在飞书中找到机器人，发送一条消息
3. 等待机器人回复（首次回复可能需要 10-30 秒）
4. 管理面板检查客户的「今日用量」是否有数据

---

## 常见问题

### 机器人不回复

- 检查管理面板中容器状态是否为「运行中」
- 打开「日志」查看是否有错误
- 确认 App ID 和 Secret 填写正确
- 确认应用已发布且用户在可用范围内

### 提示权限不足

- 回到飞书开放平台，检查权限是否全部开通
- 点击日志中提供的权限授权链接

### 机器人可以私聊但群聊不回复

- 确认 `requireMention: true`（需要 @机器人 才会回复）
- 或在飞书应用设置中调整群聊策略
