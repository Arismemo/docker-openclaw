<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€èƒ½å¸‚åœº - OpenClaw ç®¡ç†é¢æ¿</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="header">
        <div class="header-inner">
            <div class="header-brand">ğŸ¦ <span>OpenClaw</span> ç®¡ç†é¢æ¿</div>
            <nav class="header-nav">
                <a href="/" class="nav-link">ğŸ“Š æ€»è§ˆ</a>
                <a href="/skills.html" class="nav-link active">ğŸ§© æŠ€èƒ½å¸‚åœº</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <!-- æœç´¢æ  -->
        <section class="skills-search">
            <div class="search-box">
                <input type="text" id="skill-search" placeholder="æœç´¢æŠ€èƒ½â€¦ï¼ˆå¦‚ imageã€pdfã€researchï¼‰" autocomplete="off">
                <button class="btn btn-primary" onclick="searchSkills()">ğŸ” æœç´¢</button>
            </div>
            <div class="search-tabs">
                <button class="tab active" onclick="switchTab('explore', this)">ğŸ”¥ çƒ­é—¨æ¨è</button>
                <button class="tab" onclick="switchTab('installed', this)">ğŸ“¦ å·²å®‰è£…</button>
            </div>
        </section>

        <!-- æŠ€èƒ½å¡ç‰‡ç½‘æ ¼ -->
        <section class="skills-grid" id="skills-grid">
            <div class="empty-state">åŠ è½½ä¸­â€¦</div>
        </section>
    </main>

    <!-- å®‰è£…ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="modal-install">
        <div class="modal">
            <div class="modal-header">
                <h3 id="install-title">å®‰è£…æŠ€èƒ½</h3>
                <button class="btn-close" onclick="closeModal('modal-install')">âœ•</button>
            </div>
            <div class="form-group">
                <label>æŠ€èƒ½</label>
                <input type="text" id="install-slug" readonly>
            </div>
            <div class="form-group">
                <label>ç›®æ ‡å®¢æˆ·</label>
                <select id="install-target"></select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="closeModal('modal-install')">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="btn-install" onclick="confirmInstall()">å®‰è£…</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast-container" id="toasts"></div>

    <script>
        // â”€â”€ è®¤è¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function api(path, opts = {}) {
            const res = await fetch('/api' + path, {
                headers: { 'Content-Type': 'application/json', ...opts.headers },
                ...opts,
            });
            if (res.status === 401) {
                location.reload();
                throw new Error('è®¤è¯å¤±è´¥');
            }
            if (!res.ok) throw new Error((await res.json()).error || res.statusText);
            return res.json();
        }

        // â”€â”€ çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let currentTab = 'explore';
        let clients = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadExplore();
            loadClients();
            // å›è½¦æœç´¢
            document.getElementById('skill-search').addEventListener('keydown', e => {
                if (e.key === 'Enter') searchSkills();
            });
        });

        // â”€â”€ åŠ è½½å®¢æˆ·åˆ—è¡¨ï¼ˆç”¨äºå®‰è£…æ—¶é€‰æ‹©ï¼‰ â”€â”€
        async function loadClients() {
            try {
                clients = await api('/clients');
            } catch { }
        }

        // â”€â”€ æµè§ˆçƒ­é—¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadExplore() {
            const grid = document.getElementById('skills-grid');
            grid.innerHTML = '<div class="empty-state">ğŸ”„ æ­£åœ¨ä» ClawHub æ³¨å†Œè¡¨åŠ è½½â€¦</div>';
            try {
                const skills = await api('/skills/explore?limit=30');
                renderSkillCards(skills, 'explore');
            } catch (e) {
                grid.innerHTML = `<div class="empty-state">âŒ åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        // â”€â”€ æœç´¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function searchSkills() {
            const q = document.getElementById('skill-search').value.trim();
            if (!q) { loadExplore(); return; }
            const grid = document.getElementById('skills-grid');
            grid.innerHTML = '<div class="empty-state">ğŸ” æœç´¢ä¸­â€¦</div>';
            // æ¿€æ´»çƒ­é—¨ tab æ ·å¼
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            try {
                const skills = await api(`/skills/search?q=${encodeURIComponent(q)}`);
                if (skills.length === 0) {
                    grid.innerHTML = `<div class="empty-state">æœªæ‰¾åˆ°ä¸"${q}"ç›¸å…³çš„æŠ€èƒ½</div>`;
                } else {
                    renderSkillCards(skills, 'search');
                }
            } catch (e) {
                grid.innerHTML = `<div class="empty-state">âŒ æœç´¢å¤±è´¥: ${e.message}</div>`;
            }
        }

        // â”€â”€ å·²å®‰è£… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadInstalled() {
            const grid = document.getElementById('skills-grid');
            grid.innerHTML = '<div class="empty-state">ğŸ”„ æ­£åœ¨è¯»å–å®¢æˆ·æŠ€èƒ½æ•°æ®â€¦</div>';
            try {
                // ä»æ‰€æœ‰å®¢æˆ·æ±‡æ€» skill
                const allSkills = [];
                for (const c of clients) {
                    if (!c.running) continue;
                    try {
                        const data = await api(`/clients/${c.name}/skills`);
                        data.skills.forEach(s => {
                            s.client = c.name;
                            allSkills.push(s);
                        });
                    } catch { }
                }
                if (allSkills.length === 0) {
                    grid.innerHTML = '<div class="empty-state">æ— è¿è¡Œä¸­å®¢æˆ·æˆ–æš‚æ— æŠ€èƒ½æ•°æ®</div>';
                    return;
                }
                renderInstalledSkills(allSkills);
            } catch (e) {
                grid.innerHTML = `<div class="empty-state">âŒ åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        // â”€â”€ æ¸²æŸ“æ³¨å†Œè¡¨æŠ€èƒ½å¡ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderSkillCards(skills, source) {
            const grid = document.getElementById('skills-grid');
            if (skills.length === 0) {
                grid.innerHTML = '<div class="empty-state">æš‚æ— æŠ€èƒ½</div>';
                return;
            }
            grid.innerHTML = skills.map(s => `
            <div class="skill-card">
                <div class="skill-card-header">
                    <div class="skill-name">${escHtml(s.slug)}</div>
                    <span class="skill-version">${escHtml(s.version)}</span>
                </div>
                <div class="skill-desc">${escHtml(s.description || '')}</div>
                <div class="skill-card-footer">
                    ${s.time ? `<span class="skill-time">${escHtml(s.time)}</span>` : ''}
                    <button class="btn btn-primary btn-sm" onclick="showInstall('${escAttr(s.slug)}')">å®‰è£…</button>
                </div>
            </div>
        `).join('');
        }

        // â”€â”€ æ¸²æŸ“å·²å®‰è£…æŠ€èƒ½è¡¨æ ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderInstalledSkills(skills) {
            const grid = document.getElementById('skills-grid');
            // æŒ‰çŠ¶æ€åˆ†ç»„ï¼šready åœ¨å‰
            const ready = skills.filter(s => s.status === 'ready');
            const missing = skills.filter(s => s.status === 'missing');
            const disabled = skills.filter(s => s.status === 'disabled');

            // å»é‡ï¼ˆåŒå skill åœ¨ä¸åŒå®¢æˆ·ä¸­åªæ˜¾ç¤ºä¸€æ¬¡ï¼Œä½†æ ‡æ³¨å®¢æˆ·ï¼‰
            const seen = new Map();
            skills.forEach(s => {
                const key = s.slug;
                if (!seen.has(key)) seen.set(key, { ...s, clients: [s.client] });
                else seen.get(key).clients.push(s.client);
            });

            const unique = [...seen.values()];
            grid.innerHTML = unique.map(s => {
                const statusIcon = s.status === 'ready' ? 'âœ…' : s.status === 'missing' ? 'âš ï¸' : 'â¸ï¸';
                const statusClass = s.status === 'ready' ? 'status-ready' : s.status === 'missing' ? 'status-missing' : 'status-disabled';
                return `
            <div class="skill-card ${statusClass}">
                <div class="skill-card-header">
                    <div class="skill-name">${s.icon || 'ğŸ“¦'} ${escHtml(s.slug)}</div>
                    <span class="skill-badge ${statusClass}">${statusIcon} ${s.status}</span>
                </div>
                <div class="skill-desc">${escHtml(s.description || '')}</div>
                <div class="skill-card-footer">
                    <span class="skill-source">${escHtml(s.source || '')}</span>
                    <span class="skill-clients">${s.clients.map(c => c).join(', ')}</span>
                </div>
            </div>`;
            }).join('');
        }

        // â”€â”€ Tab åˆ‡æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function switchTab(tab, el) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            if (tab === 'explore') loadExplore();
            else if (tab === 'installed') loadInstalled();
        }

        // â”€â”€ å®‰è£…å¼¹çª— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showInstall(slug) {
            document.getElementById('install-slug').value = slug;
            document.getElementById('install-title').textContent = `å®‰è£… ${slug}`;
            const select = document.getElementById('install-target');
            select.innerHTML = clients
                .filter(c => c.running)
                .map(c => `<option value="${c.name}">${c.name}</option>`)
                .join('');
            if (select.options.length === 0) {
                select.innerHTML = '<option disabled>æ— è¿è¡Œä¸­çš„å®¢æˆ·</option>';
            }
            showModal('modal-install');
        }

        async function confirmInstall() {
            const slug = document.getElementById('install-slug').value;
            const target = document.getElementById('install-target').value;
            if (!slug || !target) return;

            const btn = document.getElementById('btn-install');
            btn.disabled = true;
            btn.textContent = 'å®‰è£…ä¸­â€¦';

            try {
                const result = await api(`/clients/${target}/skills/install`, {
                    method: 'POST',
                    body: JSON.stringify({ slug }),
                });
                showToast(`âœ… ${slug} å·²å®‰è£…åˆ° ${target}`, 'success');
                closeModal('modal-install');
            } catch (e) {
                showToast(`âŒ å®‰è£…å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'å®‰è£…';
            }
        }

        // â”€â”€ å·¥å…·å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(msg, type = 'success') {
            const c = document.getElementById('toasts');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        function escHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function escAttr(s) {
            return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }
    </script>
</body>

</html>