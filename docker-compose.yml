# ============================================================
# OpenClaw 多客户管理平台 - Docker Compose
# 使用方式：
#   1. docker build -t openclaw:local .     # 构建 OpenClaw 基础镜像
#   2. docker compose up -d                 # 启动管理面板
#   3. 访问 http://localhost:3000           # 通过 Web 面板管理客户
# ============================================================

services:
  # 管理面板（常驻服务）
  admin:
    build: ./admin
    container_name: openclaw-admin
    ports:
      - "3001:3000"
    volumes:
      # Docker 控制权（用于动态创建/管理客户容器）
      - /var/run/docker.sock:/var/run/docker.sock
      # 客户数据目录
      - ./clients:/app/clients
      # 配置模板
      - ./config:/app/config
      # 管理面板代码（开发模式，实时同步）
      - ./admin/public:/app/public
      - ./admin/server.js:/app/server.js
    environment:
      - HOST_PROJECT_DIR=${PWD}
      - OPENCLAW_IMAGE=openclaw:local
      - CLIENTS_DIR=/app/clients
      - CONFIG_TEMPLATE=/app/config/openclaw.json
      - TEMPLATES_DIR=/app/config/templates
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASS=${ADMIN_PASS}
      - MODELS_FILE=/app/config/models.json
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=*.feishu.cn,*.larksuite.com,open.feishu.cn,172.17.0.1,localhost,127.0.0.1
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
    restart: unless-stopped

  # OpenClaw 基础镜像构建（仅用于 build，不运行）
  openclaw-base:
    build:
      context: .
      dockerfile: Dockerfile
    image: openclaw:local
    profiles:
      - build
    command: ["echo", "✅ OpenClaw 基础镜像构建完成"]

  # === memU 记忆服务栈 ===

  # PostgreSQL + pgvector（memU 向量存储）
  memu-postgres:
    image: pgvector/pgvector:pg16
    container_name: memu-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: memu
    ports:
      - "5432:5432"
    volumes:
      - memu-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Temporal（memU 异步任务调度）
  memu-temporal:
    image: temporalio/auto-setup:1.25.1
    container_name: memu-temporal
    depends_on:
      memu-postgres:
        condition: service_healthy
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PWD=postgres
      - POSTGRES_SEEDS=memu-postgres
      - POSTGRES_DB=temporal
    ports:
      - "7233:7233"
    restart: unless-stopped

  # memU API 服务
  memu-server:
    image: nevamindai/memu-server:latest
    container_name: memu-server
    depends_on:
      memu-postgres:
        condition: service_healthy
      memu-temporal:
        condition: service_started
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-placeholder}
      - DATABASE_URL=postgresql://postgres:postgres@memu-postgres:5432/memu
      - TEMPORAL_HOST=memu-temporal:7233
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=memu-postgres,memu-temporal,localhost,127.0.0.1
    ports:
      - "8000:8000"
    restart: unless-stopped

volumes:
  memu-postgres-data:
    driver: local
